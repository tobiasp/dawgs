<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Year of the Dawg ‚Äî Hot Dog Leaderboard</title>
  <style>
    :root{
      --text:#eaf0ff;
      --muted:#9aa6c4;
      --line:#232a3a;

      --bun:#d7a66e;
      --bun2:#c98f4e;
      --sausage:#b34b3f;
      --ketchup:#d12a2a;
      --mustard:#f3c11a;
      --relish:#4ad66d;
      --neon:#7cffcb;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html{ -webkit-text-size-adjust: 100%; }
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background-image:
        url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27240%27%20height%3D%27240%27%3E%0A%20%20%3Crect%20width%3D%27240%27%20height%3D%27240%27%20fill%3D%27none%27/%3E%0A%20%20%3Ctext%20x%3D%2718%27%20y%3D%2762%27%20font-size%3D%2736%27%3E%F0%9F%8C%AD%3C/text%3E%0A%20%20%3Ctext%20x%3D%27150%27%20y%3D%27180%27%20font-size%3D%2736%27%3E%F0%9F%8C%AD%3C/text%3E%0A%20%20%3Cpath%20d%3D%27M12%20128%20C%2045%2092%2C%2078%20164%2C%20110%20128%20S%20175%20164%2C%20228%20128%27%20fill%3D%27none%27%20stroke%3D%27%23f3c11a%27%20stroke-width%3D%277%27%20stroke-linecap%3D%27round%27%20opacity%3D%27.85%27/%3E%0A%20%20%3Cpath%20d%3D%27M18%20150%20C%2055%20175%2C%2085%20120%2C%20120%20150%20S%20185%20120%2C%20225%20150%27%20fill%3D%27none%27%20stroke%3D%27%23d12a2a%27%20stroke-width%3D%276%27%20stroke-linecap%3D%27round%27%20opacity%3D%27.55%27/%3E%0A%20%20%3Ccircle%20cx%3D%2770%27%20cy%3D%27206%27%20r%3D%276%27%20fill%3D%27%234ad66d%27%20opacity%3D%27.55%27/%3E%0A%20%20%3Ccircle%20cx%3D%27196%27%20cy%3D%2744%27%20r%3D%276%27%20fill%3D%27%234ad66d%27%20opacity%3D%27.55%27/%3E%0A%3C/svg%3E"),
        radial-gradient(1200px 800px at 20% -10%, rgba(243,193,26,.22), transparent 55%),
        radial-gradient(900px 650px at 90% 10%, rgba(209,42,42,.18), transparent 55%),
        radial-gradient(900px 650px at 70% 110%, rgba(124,255,203,.10), transparent 55%),
        linear-gradient(180deg, #090a0e 0%, #07080c 100%);
      background-size: 240px 240px, auto, auto, auto, auto;
      background-repeat: repeat, no-repeat, no-repeat, no-repeat, no-repeat;

      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    a{ color: var(--neon); text-decoration:none; font-weight:800; }
    a:hover{ text-decoration:underline; }

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(7,8,12,.72);
      border-bottom: 1px solid rgba(35,42,58,.7);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(180deg, rgba(215,166,110,.95), rgba(201,143,78,.92));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .logo:before{
      content:"";
      position:absolute; inset:9px 6px;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--sausage), var(--sausage));
      box-shadow: inset 0 -10px 14px rgba(0,0,0,.25);
    }
    .logo:after{
      content:"";
      position:absolute; left:0; right:0; top:0; height:100%;
      background: repeating-linear-gradient(135deg, rgba(243,193,26,.0) 0 14px, rgba(243,193,26,.22) 14px 18px);
      mix-blend-mode:screen;
      opacity:.65;
    }
    .title h1{ margin:0; font-size:16px; letter-spacing:.2px; line-height:1.2; }
    .title .sub{ margin-top:3px; font-size:12px; color:var(--muted); line-height:1.2; }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(17,19,26,.55);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .pill label{ font-size:12px; color:var(--muted); }
    select, input[type="search"]{
      appearance:none;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:13px;
      width: 170px;
    }
    input[type="search"]{ width: 220px; }
    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      border-radius: 999px;
      padding:10px 12px;
      color:#0b0c10;
      background: linear-gradient(180deg, var(--mustard), #e9a600);
      box-shadow: 0 12px 30px rgba(243,193,26,.18);
      font-weight:1000;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }
    .toggle input{ accent-color: var(--mustard); }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 16px;
      padding-bottom: 56px;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      input[type="search"]{ width: 160px; }
    }
    @media (max-width: 420px){
      .title .sub{ display:none; }
      input[type="search"]{ width: 150px; }
      select{ width: 135px; }
    }

    /* Card */
    .card{
      background: linear-gradient(180deg, rgba(17,19,26,.92), rgba(13,15,20,.86));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card-header{
      padding:14px 14px 10px 14px;
      border-bottom: 1px solid rgba(35,42,58,.7);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-header h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .hint{ font-size:12px; color: var(--muted); }
    .card-body{ padding:14px; }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 900px){ .stats{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px){ .stats{ grid-template-columns: 1fr; } }
    .stat{
      padding:12px;
      border-radius: 16px;
      background: rgba(15,18,24,.72);
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ margin-top:6px; font-size:18px; font-weight:1000; letter-spacing:.2px; }
    .spark{
      margin-top:8px;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.05);
    }
    .spark > span{
      display:block;
      height:100%;
      width:40%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--relish), var(--neon));
      opacity:.9;
    }

    /* Desktop table */
    .table-wrap{
      margin-top: 10px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.05);
      background: rgba(0,0,0,.15);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width: 740px;
    }
    thead th{
      text-align:left;
      font-size:11px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.3px;
      text-transform:uppercase;
      padding:10px 10px;
      border-bottom: 1px solid rgba(35,42,58,.7);
      position: sticky;
      top: 0;
      background: rgba(10,12,16,.92);
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    tbody td{
      padding:12px 10px;
      border-bottom: 1px solid rgba(35,42,58,.45);
      vertical-align:middle;
    }
    tbody tr:hover{ background: rgba(243,193,26,.06); }

    .rank{ font-weight:1000; font-size:12px; width: 54px; color: var(--mustard); }
    .namecell{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .avatar{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color: var(--text);
      font-weight:1000;
      font-size:12px;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .name{ display:flex; flex-direction:column; line-height:1.15; }
    .name b{ font-size:13px; }
    .count{ font-weight:1000; font-size:14px; }
    .avg{ font-weight:1000; font-size:12px; color: var(--neon); }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.05);
      min-width: 140px;
    }
    .bar > span{
      display:block;
      height:100%;
      width:10%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--ketchup), var(--mustard));
    }
    .chip{
      font-size:11px;
      padding:6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(15,18,24,.55);
      color: var(--muted);
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .chip strong{ color: var(--text); }


    /* Momentum + tie styling */
    .chip.mom{ color: var(--text); border-color: rgba(255,255,255,.10); }
    .chip.mom .mom-sub{ color: var(--muted); font-weight:900; }
    .chip.mom.up{ border-color: rgba(74,214,109,.35); }
    .chip.mom.down{ border-color: rgba(209,42,42,.35); }
    .chip.mom.steady{ border-color: rgba(154,166,196,.22); }
    .chip.mom.lead{ border-color: rgba(243,193,26,.45); }
    .chip.mom.tie{ border-color: rgba(124,255,203,.35); }

    tbody tr.is-tied{ background: rgba(124,255,203,.05); }
    .lb-card.is-tied{ background: rgba(124,255,203,.06); border-color: rgba(124,255,203,.18); }

    /* Mobile leaderboard cards (prevents column overlap) */
    .lb-cards{ display:none; margin-top:10px; }
    .lb-card{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-radius: 16px;
      background: rgba(15,18,24,.72);
      border: 1px solid rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .lb-left{
      width:42px;
      font-weight:1000;
      color: var(--mustard);
      flex: 0 0 auto;
    }
    .lb-mid{ flex: 1 1 auto; min-width: 0; }
    .lb-mid .row1{ display:flex; align-items:center; gap:8px; }
    .lb-mid .row1 b{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lb-mid .row2{ margin-top:4px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; color: var(--muted); font-size:11px; }
    .lb-right{ width: 120px; flex: 0 0 auto; }
    .lb-right .bar{ min-width:0; width:120px; height:8px; }

    @media (max-width: 620px){
      .table-wrap{ display:none; }
      .lb-cards{ display:block; }
      .lb-right{ width: 110px; }
      .lb-right .bar{ width:110px; }
    }

    /* Feed */
    .feed{ display:flex; flex-direction:column; gap:12px; }
    .post{
      display:grid;
      grid-template-columns: 128px 1fr;
      gap:12px;
      padding:12px;
      border-radius: 16px;
      background: rgba(15,18,24,.72);
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    @media (max-width: 420px){ .post{ grid-template-columns: 1fr; } }
    .thumb{
      width:128px;
      height:128px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    @media (max-width: 420px){ .thumb{ width:100%; height:auto; aspect-ratio: 1 / 1; } }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb:after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(60px 60px at 20% 10%, rgba(255,255,255,.25), transparent 55%);
      pointer-events:none;
    }
    .meta{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .meta b{ font-size:13px; }
    .meta .t{ font-size:11px; color:var(--muted); }
    .post p{ margin:6px 0 0 0; font-size:12.5px; line-height:1.3; }

    .sentinel{ text-align:center; color: var(--muted); font-size:12px; padding: 10px 0 0 0; }

    /* Shame board */
    .shame{
      margin-top: 14px;
      background: linear-gradient(180deg, rgba(209,42,42,.16), rgba(15,18,24,.70));
      border: 1px solid rgba(209,42,42,.25);
    }
    .shame h3{ margin:0 0 8px 0; font-size:13px; }
    .shame .small{ color: var(--muted); font-size:12px; margin:0 0 10px 0; }
    .two-cols{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 700px){ .two-cols{ grid-template-columns: 1fr; } }
    .shame ul{ margin:0; padding:0 0 0 18px; }
    .shame li{ margin:6px 0; }

    /* Footer */
    .footer{
      margin-top:16px;
      color: var(--muted);
      font-size:12px;
      text-align:center;
      padding: 10px 0 22px 0;
    }

    /* Toast + hotdog rain */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(17,19,26,.92);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      color: var(--text);
      font-size:12px;
      display:none;
      gap:10px;
      align-items:center;
      max-width: 92vw;
      z-index: 99;
    }
    .toast.show{ display:flex; animation: pop .25s ease-out; }
    @keyframes pop{
      from{ transform:translateX(-50%) translateY(8px); opacity:0; }
      to{ transform:translateX(-50%) translateY(0); opacity:1; }
    }
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:80;
    }
    .confetti i{
      position:absolute;
      font-size: 24px;
      line-height: 1;
      opacity:.95;
      transform: translate3d(0,-12vh,0) rotate(0deg);
      animation: fallEmoji 1.9s linear forwards;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.45));
      user-select:none;
      will-change: transform;
    }
    @keyframes fallEmoji{
      to{
        transform: translate3d(var(--drift, 0px), 110vh, 0) rotate(540deg);
        opacity:1;
      }
    }

    /* Intro animation */
    .intro-scene{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 120;
      opacity: 1;
    }
    .intro-scene.done{ opacity: 0; transition: opacity .25s ease-out; }
    .intro-caption{
      position:absolute;
      left: 14px;
      top: 84px;
      font-weight: 1000;
      font-size: 14px;
      letter-spacing: .2px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(17,19,26,.80);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      transform: translateY(-8px);
      opacity: 0;
      animation: introCaptionIn .35s ease-out forwards .15s;
    }
    @keyframes introCaptionIn{ to{ transform: translateY(0); opacity: 1; } }
    .intro-human{
      position:absolute;
      right: 10px;
      top: 110px;
      font-size: 72px;
      transform: translateX(120px);
      opacity: 0;
      filter: drop-shadow(0 12px 30px rgba(0,0,0,.45));
      animation: humanIn .45s ease-out forwards .25s;
    }
    .intro-fork{
      position:absolute;
      right: 78px;
      top: 164px;
      font-size: 46px;
      transform: translateX(160px) rotate(-20deg);
      opacity: 0;
      animation: forkIn .55s ease-out forwards .28s;
      filter: drop-shadow(0 12px 30px rgba(0,0,0,.45));
    }
    @keyframes humanIn{ to{ transform: translateX(0); opacity: 1; } }
    @keyframes forkIn{ to{ transform: translateX(0) rotate(10deg); opacity: 1; } }
    .intro-dawg{
      position:absolute;
      left: -110px;
      top: 128px;
      font-size: 86px;
      filter: drop-shadow(0 16px 38px rgba(0,0,0,.60));
      animation: dawgFly 3.2s cubic-bezier(.2,.9,.2,1) forwards .15s;
    }
    .intro-dawg::after{
      content:"";
      position:absolute;
      left:-90px;
      top: 50%;
      width: 100px;
      height: 12px;
      transform: translateY(-50%);
      background: linear-gradient(90deg, rgba(243,193,26,.0), rgba(243,193,26,.35), rgba(209,42,42,.25), rgba(74,214,109,.22), rgba(124,255,203,.0));
      border-radius: 999px;
      filter: blur(1px);
      opacity: .9;
    }
    @keyframes dawgFly{
      0%{ transform: translateX(-10vw) rotate(-14deg) scale(1); opacity: 1; }
      70%{ transform: translateX(calc(74vw)) rotate(10deg) scale(1.10); opacity: 1; }
      88%{ transform: translateX(calc(82vw)) rotate(4deg) scale(.62); opacity: 1; }
      100%{ transform: translateX(calc(84vw)) rotate(0deg) scale(.28); opacity: 0; }
    }
    @media (max-width: 520px){
      .intro-caption{ top: 72px; }
      .intro-human{ top: 92px; font-size: 72px; }
      .intro-fork{ top: 146px; font-size: 42px; right: 74px; }
      .intro-dawg{ top: 112px; font-size: 76px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Year of the Dawg ‚Äî Hot Dog Leaderboard</h1>
          <div class="sub">Eat ‚Ä¢ Post ‚Ä¢ Ascend ‚Ä¢ Repeat. (Season runs <b>Jan 1, 2026 ‚Üí Dec 31, 2026</b>.)</div>
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <label for="scope">Scope</label>
          <select id="scope" title="Filter by time window">
            <option value="all">All time</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>

        <div class="pill">
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Search name‚Ä¶" />
        </div>

        <button class="btn" id="refreshNow" title="Fetch latest sheet data now">REFRESH NOW</button>
        <button class="btn" id="celebrate" title="Celebrate the current top Dawg">HAIL THE TOP DAWG</button>

        <label class="toggle" title="Turns up the trash-talk.">
          <input id="spicy" type="checkbox" checked/>
          Spicy Mode üå∂Ô∏è
        </label>
      </div>
    </div>
  </div>

  <main>
    <div class="layout">
      <!-- Leaderboard -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Leaderboard</h2>
            <div class="hint" id="asof">‚Äî</div>
          </div>
          <div class="hint">Tip: click a row to copy a callout.</div>
        </div>
        <div class="card-body">
          <div class="stats">
            <div class="stat">
              <div class="k">Total Dawgs Logged</div>
              <div class="v" id="totalDogs">‚Äî</div>
              <div class="spark"><span id="spark1"></span></div>
            </div>
            <div class="stat">
              <div class="k">Top Dawg</div>
              <div class="v" id="topDawg">‚Äî</div>
              <div class="spark"><span id="spark2"></span></div>
            </div>
            <div class="stat">
              <div class="k">Days Left (to Dec 31, 2026)</div>
              <div class="v" id="daysLeft">‚Äî</div>
              <div class="spark"><span id="spark3"></span></div>
            </div>

            <div class="stat">
              <div class="k">Momentum (7d)</div>
              <div class="v" id="momentumStat">‚Äî</div>
              <div class="spark"><span id="spark4"></span></div>
            </div>

            <div class="stat" style="grid-column: 1 / -1;">
              <div class="k">Cheesy Dawg Quote of the Day</div>
              <div class="v" id="dailyQuote" style="font-size:14px; line-height:1.25;">‚Äî</div>
              <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <span class="chip">üïí <strong id="lastRefresh">Not refreshed yet</strong></span>
                <span class="chip">üîÅ Auto-refresh every <strong id="refreshIntervalLabel">5</strong> min</span>
                <span class="chip">‚å®Ô∏è <strong>/</strong> search ‚Ä¢ <strong>Esc</strong> clear</span>
              </div>
            </div>
          </div>

          <div class="table-wrap">
            <table aria-label="Leaderboard table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Dawg</th>
                  <th>Count</th>
                  <th>Avg/day</th>
                  <th>Heat</th>
                  <th>Momentum</th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="lb-cards" id="lbCards" aria-label="Mobile leaderboard cards"></div>
        </div>
      </section>

      <!-- Latest -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Latest Submissions</h2>
            <div class="hint">Endless dawg gallery. Scroll forever.</div>
          </div>
          <div class="hint"><span class="chip">üì∑ <strong id="feedShown">0</strong>/<strong id="feedTotal">0</strong></span></div>
        </div>
        <div class="card-body">
          <div class="feed" id="feed"></div>
          <div id="feedSentinel" class="sentinel">Loading more dawgs‚Ä¶</div>

          <div class="card shame">
            <div class="card-body">
              <h3>Hall of (Friendly) Shame</h3>
              <p class="small">Low counts only. This is peer pressure with a warm hug.</p>
              <div class="two-cols">
                <div>
                  <div class="chip">ü•∂ Cold bun energy</div>
                  <ul id="shameList"></ul>
                </div>
                <div>
                  <div class="chip">üì£ Suggested heckles</div>
                  <ul id="heckles"></ul>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>

    <div class="footer">
      Data: Google Sheet + Drive photos. If images don‚Äôt load, you probably need Drive access in your browser.
    </div>
  </main>

  <div class="intro-scene" id="introScene" aria-hidden="true">
    <div class="intro-caption">A wild dawg appears‚Ä¶ (oh no)</div>
    <div class="intro-human">üòã</div>
    <div class="intro-fork">üç¥</div>
    <div class="intro-dawg">üå≠</div>
  </div>

  <div class="confetti" id="confetti"></div>
  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const SHEET_ID = "17Y2SosZ5wmAjsB1FUyr2AOy3r7-PjMdOC1Mfhkur4ws";
const TAB_TALLY = "Active Tally";
const TAB_RESPONSES = "Form Responses";

const AUTO_REFRESH_MIN = 5;
const LOAD_SUBMISSIONS_LIMIT = 20000; // cap for safety, but "infinite" for normal use
const FEED_PAGE_SIZE = 24;

/* =========================
   STATE
========================= */
let PARTICIPANTS = [];
let SUBMISSIONS = [];

const FEED_STATE = {
  key: "",
  cursor: 0,
  list: [],
  usedComments: new Set()
};

/* =========================
   STRINGS
========================= */
const HECKLES_MILD = [
  "Not saying you‚Äôve got cold bun energy‚Ä¶ but your bun is literally room temp.",
  "One dog today = one less personality trait tomorrow. Choose wisely.",
  "Post a dog. Feed the spreadsheet. Obey the Dawgocracy.",
  "You don‚Äôt need motivation ‚Äî you need mustard.",
  "If you can scroll this, you can chew.",
  "Friendly reminder: the bun remembers.",
  "Do it for the spreadsheet. It‚Äôs doing its best.",
  "One photo = one less excuse.",
  "Momentum starts with one dog.",
  "Today‚Äôs forecast: 90% chance of mustard."
];

const HECKLES_SPICY = [
  "You‚Äôre not ‚Äòsaving room‚Äô ‚Äî you‚Äôre dodging greatness. Fix it.",
  "At this point the bun has more ambition than you do.",
  "Your count is low enough to be a rumor. Make it real.",
  "Stop spectating. Start chewing. The spreadsheet wants ketchup.",
  "Your tally is embarrassing in a very fixable way.",
  "The leaderboard called. It asked if you‚Äôre okay.",
  "No dog? No peace.",
  "This is a competition, not a silent retreat.",
  "Post one dog. Minimum. Then talk.",
  "Stop being a background character in your own bun story."
];

/* =========================
   HELPERS
========================= */
const $ = (sel) => document.querySelector(sel);

function showToast(msg) {
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=>t.classList.remove("show"), 2400);
}

function spicyOn(){ return $("#spicy").checked; }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function driveIdFromUrl(url){
  const m = String(url||"").match(/[?&]id=([^&]+)/);
  return m ? m[1] : null;
}
function driveThumb(url){
  const id = driveIdFromUrl(url);
  if(!id) return null;
  return `https://drive.google.com/thumbnail?id=${id}&sz=w400-h400`;
}

function pseudonymFromEmail(email){
  const e = String(email || "");
  if(!e) return "Mystery Dawg";
  let h = 2166136261;
  for(let i=0;i<e.length;i++){ h ^= e.charCodeAt(i); h = Math.imul(h, 16777619); }
  const code = (h >>> 0) % 1000;
  return "Dawg " + String(code).padStart(3, "0");
}

function initials(name){
  const s = (name || "").trim();
  if(!s) return "??";
  const parts = s.split(/\s+/).filter(Boolean);
  if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
  return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
}

function parseDate(s){
  if (s instanceof Date) return s;
  if (typeof s === "number") return new Date(s);
  const str = String(s ?? "").trim();
  if (!str) return new Date(NaN);

  const m = str.match(/^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)$/);
  if (m) {
    return new Date(
      Number(m[1]),
      Number(m[2]),
      Number(m[3]),
      Number(m[4] || 0),
      Number(m[5] || 0),
      Number(m[6] || 0)
    );
  }

  let cleaned = str.replace(/\.\d+$/, "");
  if (/^\d{4}-\d{2}-\d{2}\s+\d/.test(cleaned)) cleaned = cleaned.replace(" ", "T");
  let d = new Date(cleaned);
  if (!isNaN(d.getTime())) return d;
  d = new Date(cleaned + "Z");
  return d;
}

function fmtDate(s){
  const d = parseDate(s);
  if (!d || isNaN(d.getTime())) return String(s ?? "");
  return d.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
}

async function copyText(s){
  try {
    await navigator.clipboard.writeText(s);
    showToast("Copied. Apply peer pressure responsibly üå≠");
  } catch(e) {
    showToast("Couldn‚Äôt copy (clipboard blocked).");
  }
}

function animateInt(el, toValue){
  const to = Number(toValue) || 0;
  const from = Number(el.dataset.v || String(el.textContent || "0").replace(/,/g,"")) || 0;
  if(from === to){ el.dataset.v = String(to); el.textContent = to.toLocaleString(); return; }
  const start = performance.now();
  const dur = 420;
  function step(now){
    const t = Math.min(1, (now - start) / dur);
    const eased = 1 - Math.pow(1 - t, 3);
    const v = Math.round(from + (to - from) * eased);
    el.textContent = v.toLocaleString();
    if(t < 1) requestAnimationFrame(step);
    else el.dataset.v = String(to);
  }
  requestAnimationFrame(step);
}

function confettiBurst(){
  const root = $("#confetti");
  root.innerHTML = "";
  const n = 150;
  for(let i=0;i<n;i++) {
    const p = document.createElement("i");
    const roll = Math.random();
    p.textContent = roll < 0.78 ? "üå≠" : (roll < 0.92 ? "‚ú®" : "üí´");
    p.style.left = (Math.random()*100) + "vw";
    p.style.setProperty("--drift", ((Math.random()*2-1)*140).toFixed(0) + "px");
    p.style.animationDelay = (Math.random()*0.35) + "s";
    p.style.animationDuration = (1.7 + Math.random()*1.6) + "s";
    p.style.fontSize = (18 + Math.random()*20) + "px";
    root.appendChild(p);
  }
  setTimeout(()=>root.innerHTML="", 3600);
}

/* =========================
   COMMENTARY + DAILY QUOTE
========================= */
function seededRandFromString(seedStr){
  let h = 2166136261;
  for(let i=0;i<seedStr.length;i++) { h ^= seedStr.charCodeAt(i); h = Math.imul(h, 16777619); }
  return function(){
    h += 0x6D2B79F5;
    let t = Math.imul(h ^ (h >>> 15), 1 | h);
    t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function dailySeed(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

const MILD_COMMENTS = [
  "Spreadsheet fed. Society improved.",
  "Bun integrity: strong. Commitment: stronger.",
  "This is what leadership looks like (in a bun).",
  "Audacious. Carby. Inspirational.",
  "A humble flex ‚Äî but still a flex.",
  "Eat. Post. Repeat. You understood the assignment.",
  "Shoutout to the bun for showing up today.",
  "Absolute professionalism (for a hot dog photo).",
  "We accept this offering.",
  "High-quality documentation. A+.",
  "That dog looks like it had a mission statement.",
  "No notes. Only applause. And mustard."
];

const SPICY_COMMENTS = [
  "Unhinged hot dog conduct. We respect the audacity.",
  "That dog just got speedrun‚Äôd. No survivors. Iconic.",
  "This isn‚Äôt lunch ‚Äî it‚Äôs a power move with condiments.",
  "Violent bun energy. Absolutely feral. Love that for you.",
  "You ate like you‚Äôre trying to frighten the leaderboard. Effective.",
  "The bun looks innocent. The vibe does not.",
  "The spreadsheet is blushing. Keep going.",
  "You didn‚Äôt eat a dog ‚Äî you erased it from history.",
  "Main character at the food court. I see you.",
  "This is bun-based domination."
];

const MILD_EXTRAS = [
  "{name} is on a roll. Literally.",
  "{name} keeps the Dawgocracy alive.",
  "{name} understood the assignment.",
  "{name} is building a legacy, one bun at a time.",
  "{name} is quietly farming W‚Äôs."
];

const SPICY_EXTRAS = [
  "{name} chose chaos and condiments.",
  "{name} woke up and said ‚Äúbun.‚Äù",
  "{name} is speedrunning this season.",
  "{name} is cooking with disrespect.",
  "{name} is a problem (for everyone else)."
];

function pickComment(name, spicy, submissionKey, usedSet){
  const day = dailySeed();
  const pool = spicy ? SPICY_COMMENTS : MILD_COMMENTS;
  const extras = spicy ? SPICY_EXTRAS : MILD_EXTRAS;

  const r = seededRandFromString(String(submissionKey||"") + "|" + day + "|" + (spicy?"S":"M"));
  let idx = Math.floor(r() * pool.length);
  if(usedSet && usedSet.has(idx)) idx = (idx + 3) % pool.length;
  if(usedSet) usedSet.add(idx);

  let msg = pool[idx];
  if(r() < 0.65) msg += " " + extras[Math.floor(r() * extras.length)];
  if(r() < 0.18) msg += " " + (spicy ? "No witnesses. Only buns." : "Certified.");
  return msg.replaceAll("{name}", name);
}

function buildDailyQuote(rows, subs){
  const r = seededRandFromString(dailySeed() + (spicyOn() ? "|spicy" : "|mild"));
  const pick = (arr)=> arr[Math.floor(r()*arr.length)];

  const top = rows[0];
  const bottom = rows.slice().filter(x => (x.displayName||"").toLowerCase() !== "unknown")
    .sort((a,b)=>(Number(a.count)||0)-(Number(b.count)||0))[0];
  const recent = subs[0];

  const mild = [
    `üå≠ ‚ÄúA hot dog posted is a hot dog that counts.‚Äù Today: ${top?.displayName||"someone"} is leading with ${top?.count||0}.`,
    `üå≠ ‚ÄúRespect the bun. Fear the tally.‚Äù One dog today prevents tomorrow‚Äôs shame.`,
    `üå≠ ‚ÄúEvidence wins.‚Äù Photo, timestamp, glory. That‚Äôs the whole religion.`,
    `üå≠ ‚ÄúDog + carb = destiny.‚Äù If you‚Äôre behind, that‚Äôs just plot development.`,
    `üå≠ Shoutout to ${recent?.name||"the latest legend"} for feeding the spreadsheet.`
  ];
  const spicy = [
    `üå≠ ‚ÄúThe spreadsheet is eternal, and it has receipts.‚Äù ${top?.displayName||"Someone"} leads with ${top?.count||0}.`,
    `üå≠ ‚ÄúPost the dog. Respectfully.‚Äù The bun is watching.`,
    `üå≠ ‚ÄúEat now, negotiate later.‚Äù If you‚Äôre at ${bottom?.count||0}, that‚Äôs not ‚Äúlow‚Äù ‚Äî that‚Äôs ‚Äúconcerning.‚Äù`,
    `üå≠ ‚ÄúMustard is a mindset.‚Äù Today‚Äôs vibe: speedrun the year.`,
    `üå≠ ‚ÄúIf it‚Äôs not photographed, it didn‚Äôt happen.‚Äù No alibis.`
  ];
  const tag = spicyOn()
    ? pick(["Also: bun confidence at historic highs.", "Also: the condiments are loud and I approve.", "Also: this is peer pressure with sparkles.", "Also: receipts only."])
    : pick(["Also: cinematic bun work.", "Also: the spreadsheet thanks you.", "Also: keep it silly, keep it honest.", "Also: this is our Super Bowl."]);

  return `${spicyOn() ? pick(spicy) : pick(mild)} ${tag}`;
}

/* =========================
   CALC + RENDER
========================= */
function compute(scopeDays){
  const now = new Date();
  const cutoff = scopeDays === "all" ? null : new Date(now.getTime() - Number(scopeDays)*24*3600*1000);

  const subs = (SUBMISSIONS || [])
    .map(s => ({...s, d: parseDate(s.ts)}))
    .filter(s => !cutoff || (s.d && !isNaN(s.d.getTime()) && s.d >= cutoff))
    .sort((a,b)=> (b.d - a.d));

  const lastByEmail = new Map();
  for(const s of subs){
    const key = s.email || "";
    if(!key) continue;
    if(!lastByEmail.has(key)) lastByEmail.set(key, s.d);
  }

  const rows = (PARTICIPANTS || [])
    .map(p => ({
      ...p,
      displayName: (p.name && p.name.trim()) ? p.name.trim() : pseudonymFromEmail(p.email),
      lastSeen: lastByEmail.get(p.email) || null
    }))
    .sort((a,b)=> (Number(b.count)||0) - (Number(a.count)||0) || (a.displayName||"").localeCompare(b.displayName||""));

  const totalDogs = rows.reduce((acc,r)=>acc + (Number(r.count)||0), 0);
  const top = rows[0] || {displayName:"‚Äî", count:0, email:""};

  return {rows, subs, totalDogs, top};
}

function buildRankMap(rows){
  const map = new Map();
  let prevCount = null;
  let prevRank = 0;

  for(let i=0;i<rows.length;i++){
    const r = rows[i];
    const c = Number(r.count)||0;

    let rank = 1;
    if(i === 0) rank = 1;
    else if(c === prevCount) rank = prevRank;
    else rank = i + 1;

    const nextCount = (i < rows.length - 1) ? (Number(rows[i+1].count)||0) : null;
    const tied = (i > 0 && c === prevCount) || (i < rows.length - 1 && nextCount === c);

    map.set(r.email, {rank, tied});
    prevCount = c;
    prevRank = rank;
  }
  return map;
}

function computeMomentum(){
  const now = new Date();
  const cutoff7 = new Date(now.getTime() - 7*24*3600*1000);
  const cutoff14 = new Date(now.getTime() - 14*24*3600*1000);

  const last7 = new Map();
  const prev7 = new Map();

  for(const s of (SUBMISSIONS || [])){
    const d = parseDate(s.ts);
    if(!d || isNaN(d.getTime())) continue;
    const email = String(s.email||"").trim();
    if(!email) continue;

    if(d >= cutoff7){
      last7.set(email, (last7.get(email)||0) + 1);
    } else if(d >= cutoff14){
      prev7.set(email, (prev7.get(email)||0) + 1);
    }
  }

  const countNow = new Map();
  for(const p of (PARTICIPANTS || [])){
    const email = String(p.email||"").trim();
    if(!email) continue;
    countNow.set(email, Number(p.count)||0);
  }

  // include any email that has submissions but is missing from participants
  for(const email of last7.keys()) if(!countNow.has(email)) countNow.set(email, last7.get(email)||0);
  for(const email of prev7.keys()) if(!countNow.has(email)) countNow.set(email, 0);

  let topNow = 0;
  let topThen = 0;
  for(const [email, cNow] of countNow){
    const l7 = last7.get(email)||0;
    const cThen = Math.max(0, (Number(cNow)||0) - l7);
    if(cNow > topNow) topNow = cNow;
    if(cThen > topThen) topThen = cThen;
  }

  const info = new Map();
  for(const [email, cNow] of countNow){
    const l7 = last7.get(email)||0;
    const p7 = prev7.get(email)||0;
    const cThen = Math.max(0, (Number(cNow)||0) - l7);

    const gapNow = topNow - (Number(cNow)||0);
    const gapThen = topThen - cThen;
    const gapDelta = gapThen - gapNow; // + => catching up
    const weekDelta = l7 - p7;

    info.set(email, {last7:l7, prev7:p7, weekDelta, gapNow, gapThen, gapDelta});
  }

  return {info, topNow, topThen};
}

function formatLeadersLabel(leaders, topCount){
  if(!leaders || !leaders.length || !(topCount > 0)) return "‚Äî";
  if(leaders.length === 1) return `${leaders[0].displayName} (${topCount})`;
  const names = leaders.slice(0,3).map(x => x.displayName);
  if(leaders.length <= 3) return `Tie: ${names.join(", " )} (${topCount})`;
  return `Tie: ${names.join(", " )} +${leaders.length-3} (${topCount})`;
}

function momentumMeta(r, m, leadersSet, topCount){
  const last7 = m ? (m.last7||0) : 0;
  const prev7 = m ? (m.prev7||0) : 0;
  const gapDelta = m ? (m.gapDelta||0) : 0;

  if(leadersSet && leadersSet.has(r.email) && topCount > 0){
    const tieLead = leadersSet.size > 1;
    const cls = tieLead ? "tie" : "lead";
    const icon = tieLead ? "ü§ù" : "üëë";
    const value = tieLead ? "Tied" : "Lead";
    const title = tieLead
      ? `Tied for the lead at ${topCount}. 7d: ${last7} (prev7: ${prev7}).`
      : `Leading at ${topCount}. 7d: ${last7} (prev7: ${prev7}).`;
    return {cls, icon, value, title, last7, prev7, gapDelta};
  }

  let cls = "steady";
  let icon = "‚è∏Ô∏è";
  let value = "0";
  let verb = "held";

  if(gapDelta > 0){ cls = "up"; icon = "‚¨ÜÔ∏è"; value = `+${gapDelta}`; verb = "shrunk"; }
  if(gapDelta < 0){ cls = "down"; icon = "‚¨áÔ∏è"; value = `${gapDelta}`; verb = "grew"; }

  const title = `Gap vs the leader ${verb} by ${Math.abs(gapDelta)} over the last 7 days. 7d: ${last7} (prev7: ${prev7}).`;
  return {cls, icon, value, title, last7, prev7, gapDelta};
}

function buildCallout(r, ctx, spicy){
  const d = r.displayName;
  const c = Number(r.count)||0;
  const topCount = Number(ctx?.topCount)||0;
  const leadersSet = ctx?.leadersSet || new Set();
  const leaders = ctx?.leaders || [];

  const isLeader = (topCount > 0) && leadersSet.has(r.email);
  const delta = topCount - c;

  if(isLeader){
    const tieLead = leaders.length > 1;
    return spicy
      ? (tieLead
        ? `ü§ù CO-TOP DAWG ü§ù ${d} is tied for the lead (${c}).`
        : `üö® TOP DAWG üö® ${d} leads with ${c}. Bow to the bun.`)
      : (tieLead
        ? `ü§ù Co-Top Dawg: ${d} is tied for the lead with ${c}.`
        : `üå≠ Top Dawg: ${d} leads with ${c}. Respect the bun.`);
  }

  if(delta <= 2 && delta >= 1){
    return spicy
      ? `${d} is within ${delta} of the lead. The bun is nervous.`
      : `${d} is close ‚Äî only ${delta} behind the lead.`;
  }

  if(c <= 2){
    return spicy
      ? `${d}, your count is low enough to be a rumor. (${c}.) Fix it. üå≠`
      : `${d}, we miss your dawgs. (${c} total.) Post one soon.`;
  }

  return spicy
    ? `${d} has ${c}. The lead is ${topCount}. Choose condiments wisely.`
    : `${d} has ${c}. Lead is ${topCount}. Plenty of runway ‚Äî go get it.`;
}

function resetFeed(list){
  const feed = $("#feed");
  const sentinel = $("#feedSentinel");
  if(!feed || !sentinel) return;

  FEED_STATE.list = list;
  FEED_STATE.cursor = 0;
  FEED_STATE.usedComments = new Set();
  feed.innerHTML = "";

  $("#feedTotal").textContent = String(list.length);
  $("#feedShown").textContent = "0";

  sentinel.textContent = list.length ? "Loading more dawgs‚Ä¶" : "No submissions (yet).";
  appendMoreFeed();
}

function appendMoreFeed(){
  const feed = $("#feed");
  const sentinel = $("#feedSentinel");
  if(!feed || !sentinel) return;

  if(FEED_STATE.cursor >= FEED_STATE.list.length){
    sentinel.textContent = "That‚Äôs all the dawgs. For now.";
    return;
  }

  const start = FEED_STATE.cursor;
  const end = Math.min(FEED_STATE.list.length, start + FEED_PAGE_SIZE);
  const slice = FEED_STATE.list.slice(start, end);
  FEED_STATE.cursor = end;

  slice.forEach((s) => {
    const name = (s.name && s.name.trim()) ? s.name.trim() : pseudonymFromEmail(s.email);
    const thumb = s.photo ? driveThumb(s.photo) : null;

    const key = `${s.email}|${s.ts}|${s.photo}`;
    const comment = pickComment(name, spicyOn(), key, FEED_STATE.usedComments);

    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <div class="thumb">${thumb ? `<img src="${thumb}" alt="Hot dog submission photo" loading="lazy">` : ""}</div>
      <div>
        <div class="meta">
          <div>
            <b>${escapeHtml(name)}</b>
            <div class="t">${fmtDate(s.ts)} ‚Ä¢ <span class="chip">+1 dawg</span></div>
          </div>
          <div style="text-align:right">
            ${s.photo ? `<a href="${s.photo}" target="_blank" rel="noreferrer">Open</a>` : ""}
          </div>
        </div>
        <p>${escapeHtml(comment)}</p>
      </div>
    `;
    feed.appendChild(div);
  });

  $("#feedShown").textContent = String(FEED_STATE.cursor);
  sentinel.textContent = (FEED_STATE.cursor >= FEED_STATE.list.length) ? "That‚Äôs all the dawgs. For now." : "Loading more dawgs‚Ä¶";
}

function render(){
  const scope = $("#scope").value;
  const q = ($("#q").value || "").trim().toLowerCase();
  const {rows, subs, totalDogs} = compute(scope);

  const topCount = rows.length ? (Number(rows[0].count)||0) : 0;
  const leaders = rows.filter(r => (Number(r.count)||0) === topCount && topCount > 0);
  const leadersSet = new Set(leaders.map(r => r.email));

  const rankMap = buildRankMap(rows);
  const momentum = computeMomentum();
  const ctx = {topCount, leaders, leadersSet};

  $("#asof").textContent = `Live from Google Sheets ‚Ä¢ Scope: ${scope === "all" ? "All time" : `last ${scope} days`} ‚Ä¢ Tabs: "${TAB_TALLY}", "${TAB_RESPONSES}"`;

  $("#dailyQuote").textContent = buildDailyQuote(rows, subs);

  animateInt($("#totalDogs"), totalDogs);
  $("#topDawg").textContent = formatLeadersLabel(leaders, topCount);

  // Momentum headline: biggest gap move vs leader over the last 7 days
  const movers = rows.map(r => ({r, m: momentum.info.get(r.email)})).filter(x => x.m);
  let best = null;
  for(const x of movers){
    const score = Math.abs(Number(x.m.gapDelta)||0);
    if(!best || score > best.score) best = {score, ...x};
  }
  const ms = $("#momentumStat");
  const s4 = $("#spark4");
  if(ms){
    if(!best || !(topCount > 0)){
      ms.textContent = "‚Äî";
      if(s4) s4.style.width = "2%";
    } else {
      const gd = Number(best.m.gapDelta)||0;
      const icon = gd > 0 ? "‚¨ÜÔ∏è" : (gd < 0 ? "‚¨áÔ∏è" : "‚è∏Ô∏è");
      const val = gd > 0 ? `+${gd}` : `${gd}`;
      ms.textContent = `${icon} ${best.r.displayName} ${val}`;
      if(s4) s4.style.width = Math.min(100, Math.max(4, 25 + best.score * 18)) + "%";
    }
  }

  const start = new Date("2026-01-01T00:00:00");
  const end = new Date("2026-12-31T23:59:59");
  const now = new Date();
  const totalSeasonDays = Math.max(1, Math.ceil((end - start) / (24*3600*1000)));

  let daysLeft = 0;
  if (now <= end) {
    daysLeft = Math.floor((end - now) / (24*3600*1000)) + 1;
  }
  animateInt($("#daysLeft"), daysLeft);
  $("#refreshIntervalLabel").textContent = String(AUTO_REFRESH_MIN);

  const clampedNow = (now <= end) ? now : end;
  const daysElapsed = (now >= start) ? Math.min(totalSeasonDays, Math.floor((clampedNow - start) / (24*3600*1000)) + 1) : 0;

  $("#spark1").style.width = Math.min(100, 20 + (totalDogs % 80)) + "%";
  $("#spark2").style.width = Math.min(100, 25 + (topCount * 3)) + "%";
  $("#spark3").style.width = Math.max(2, Math.round((daysLeft / totalSeasonDays) * 100)) + "%";

  const filtered = rows.filter(r => {
    const a = (r.displayName||"").toLowerCase();
    return !q || a.includes(q);
  });

  const max = Math.max(1, topCount || 0);

  const tbody = $("#tbody");
  tbody.innerHTML = "";
  filtered.forEach((r, idx) => {
    const tr = document.createElement("tr");

    const rankInfo = rankMap.get(r.email) || {rank: idx + 1, tied: false};
    const rankLabel = rankInfo.tied ? `T${rankInfo.rank}` : `#${rankInfo.rank}`;
    const rankTitle = rankInfo.tied ? `Tied for #${rankInfo.rank}` : `Rank #${rankInfo.rank}`;
    if(rankInfo.tied) tr.classList.add("is-tied");

    const firstPhoto = (subs.find(s=>s.email===r.email)?.photo)||"";
    const id = driveIdFromUrl(firstPhoto);
    const ava = id ? `<img src="${driveThumb(firstPhoto)}" alt="" loading="lazy">` : initials(r.displayName);

    const last = (r.lastSeen && !isNaN(r.lastSeen.getTime())) ? r.lastSeen.toLocaleString([], {month:"short", day:"2-digit"}) : "‚Äî";
    const pct = max ? Math.max(2, Math.round(((Number(r.count)||0) / max) * 100)) : 0;
    const avg = (daysElapsed > 0) ? ((Number(r.count)||0) / daysElapsed).toFixed(2) : "0.00";

    const mom = momentumMeta(r, momentum.info.get(r.email), leadersSet, topCount);
    const momChip = `<span class="chip mom ${mom.cls}" title="${escapeHtml(mom.title)}">${mom.icon} <strong>${escapeHtml(mom.value)}</strong> <span class="mom-sub">7d ${mom.last7}</span></span>`;

    tr.innerHTML = `
      <td class="rank" title="${rankTitle}">${rankLabel}</td>
      <td>
        <div class="namecell">
          <div class="avatar">${ava}</div>
          <div class="name">
            <b>${escapeHtml(r.displayName)}</b>
          </div>
        </div>
      </td>
      <td class="count">${Number(r.count)||0}</td>
      <td class="avg">${avg}</td>
      <td>
        <div class="bar" title="${pct}% of top Dawg">
          <span style="width:${pct}%"></span>
        </div>
      </td>
      <td>${momChip}</td>
      <td><span class="chip">üïµÔ∏è <strong>${last}</strong></span></td>
    `;
    tr.addEventListener("click", () => copyText(buildCallout(r, ctx, spicyOn())));
    tbody.appendChild(tr);
  });

  const lbCards = $("#lbCards");
  lbCards.innerHTML = "";
  filtered.forEach((r, idx) => {
    const rankInfo = rankMap.get(r.email) || {rank: idx + 1, tied: false};
    const rankLabel = rankInfo.tied ? `T${rankInfo.rank}` : `#${rankInfo.rank}`;

    const firstPhoto = (subs.find(s=>s.email===r.email)?.photo)||"";
    const id = driveIdFromUrl(firstPhoto);
    const ava = id ? `<img src="${driveThumb(firstPhoto)}" alt="" loading="lazy">` : initials(r.displayName);

    const last = (r.lastSeen && !isNaN(r.lastSeen.getTime())) ? r.lastSeen.toLocaleString([], {month:"short", day:"2-digit"}) : "‚Äî";
    const pct = max ? Math.max(2, Math.round(((Number(r.count)||0) / max) * 100)) : 0;
    const avg = (daysElapsed > 0) ? ((Number(r.count)||0) / daysElapsed).toFixed(2) : "0.00";

    const mom = momentumMeta(r, momentum.info.get(r.email), leadersSet, topCount);
    const momChip = `<span class="chip mom ${mom.cls}" title="${escapeHtml(mom.title)}">${mom.icon} <strong>${escapeHtml(mom.value)}</strong> <span class="mom-sub">7d ${mom.last7}</span></span>`;

    const card = document.createElement("div");
    card.className = "lb-card" + (rankInfo.tied ? " is-tied" : "");
    card.innerHTML = `
      <div class="lb-left">${rankLabel}</div>
      <div class="lb-mid">
        <div class="row1">
          <div class="avatar" style="width:30px;height:30px;border-radius:12px;">${ava}</div>
          <b title="${escapeHtml(r.displayName)}">${escapeHtml(r.displayName)}</b>
        </div>
        <div class="row2">
          <span class="chip">Count <strong>${Number(r.count)||0}</strong></span>
          <span class="chip">Avg/day <strong>${avg}</strong></span>
          ${momChip}
          <span class="chip">Seen <strong>${last}</strong></span>
        </div>
      </div>
      <div class="lb-right">
        <div class="bar" title="${pct}% of top Dawg"><span style="width:${pct}%"></span></div>
      </div>
    `;
    card.addEventListener("click", () => copyText(buildCallout(r, ctx, spicyOn())));
    lbCards.appendChild(card);
  });

  // Shame board
  const shame = rows
    .filter(r => (r.displayName||"").toLowerCase() !== "unknown")
    .slice()
    .sort((a,b)=>(Number(a.count)||0)-(Number(b.count)||0))
    .slice(0, Math.min(6, rows.length));

  const shameList = $("#shameList");
  shameList.innerHTML = "";
  shame.forEach(r => {
    const c = Number(r.count)||0;
    const li = document.createElement("li");
    li.innerHTML = `<b>${escapeHtml(r.displayName)}</b> ‚Äî ${c} dawg${c===1?"":"s"}`;
    shameList.appendChild(li);
  });

  const heckles = $("#heckles");
  heckles.innerHTML = "";
  const pool = spicyOn() ? HECKLES_SPICY : HECKLES_MILD;
  const rr = seededRandFromString(dailySeed() + (spicyOn() ? "|hs" : "|hm"));
  const idxs = new Set();
  while(idxs.size < Math.min(5, pool.length)) idxs.add(Math.floor(rr() * pool.length));
  Array.from(idxs).forEach(i => {
    const li = document.createElement("li");
    li.textContent = pool[i];
    heckles.appendChild(li);
  });

  // endless feed rebuild if key changed
  const feedKey = `${scope}|${subs.length}|${subs[0] ? subs[0].ts : ""}|${spicyOn() ? "S" : "M"}`;
  if(FEED_STATE.key !== feedKey){
    FEED_STATE.key = feedKey;
    resetFeed(subs.slice()); // newest-first
  }
}

/* =========================
   GOOGLE SHEETS LOADER (GViz JSONP)
========================= */
function gvizQuery(sheetName, tq){
  return new Promise((resolve, reject) => {
    if(!window.google) window.google = {};
    if(!window.google.visualization) window.google.visualization = {};
    if(!window.google.visualization.Query) window.google.visualization.Query = {};

    const cbKey = "__gviz_cb_" + Math.random().toString(16).slice(2);
    window[cbKey] = (resp) => { cleanup(); resolve(resp); };
    window.google.visualization.Query.setResponse = window[cbKey];

    const script = document.createElement("script");
    const url = new URL(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`);
    url.searchParams.set("tqx", "out:json");
    url.searchParams.set("sheet", sheetName);
    url.searchParams.set("tq", tq || "select *");
    url.searchParams.set("_", String(Date.now()));
    script.src = url.toString();
    script.async = true;

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("GViz request timed out"));
    }, 12000);

    script.onerror = () => {
      cleanup();
      reject(new Error("GViz request failed"));
    };

    function cleanup(){
      clearTimeout(timer);
      script.remove();
      delete window[cbKey];
    }

    document.head.appendChild(script);
  });
}

function gvizToObjects(resp){
  const cols = (resp && resp.table && resp.table.cols ? resp.table.cols : []).map(c => c.label || c.id || "");
  const rows = (resp && resp.table && resp.table.rows) ? resp.table.rows : [];
  const out = [];
  for(const r of rows){
    const obj = {};
    const cells = r.c || [];
    for(let i=0;i<cols.length;i++) {
      const key = cols[i] || ("col" + i);
      obj[key] = (cells[i] && ("v" in cells[i])) ? cells[i].v : null;
    }
    out.push(obj);
  }
  return out;
}

async function loadLiveData(){
  try {
    const tallyResp = await gvizQuery(TAB_TALLY, "select *");
    const tallyObjs = gvizToObjects(tallyResp);

    const newParticipants = [];
    for(const row of tallyObjs){
      const email = row["Email"] || row["Email Address"] || row["email"] || row["col1"];
      const name = row["Name"] || row["name"] || row["col2"];
      const count = Number(row["Count"] ?? row["count"] ?? row["col3"]);
      if(!email) continue;
      newParticipants.push({
        email: String(email).trim(),
        name: name ? String(name).trim() : "",
        count: isFinite(count) ? count : 0
      });
    }

    const respResp = await gvizQuery(TAB_RESPONSES, "select *");
    const respObjs = gvizToObjects(respResp);

    const newSubs = [];
    for(const row of respObjs){
      const ts = row["Timestamp"] || row["timestamp"] || row["col1"];
      const photo = row["Photo of dog in question"] || row["Photo"] || row["photo"] || row["col2"];
      const email = row["Email Address"] || row["Email"] || row["email"] || row["col3"];
      const name = row["Your name (will pull from previous answers)"] || row["Your name"] || row["Name"] || row["col4"];
      if(!ts || !email) continue;
      newSubs.push({
        ts: String(ts),
        photo: photo ? String(photo) : "",
        email: String(email).trim(),
        name: name ? String(name).trim() : ""
      });
    }

    newSubs.sort((a,b)=> parseDate(b.ts) - parseDate(a.ts));
    SUBMISSIONS = newSubs.slice(0, LOAD_SUBMISSIONS_LIMIT);
    PARTICIPANTS = newParticipants;

    $("#lastRefresh").textContent = new Date().toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
    showToast("Fresh dawgs fetched üßæ");
    FEED_STATE.key = ""; // force feed rebuild
    render();
  } catch(e) {
    console.warn("Live fetch failed:", e);
    showToast("Live fetch failed ‚Äî using last known data");
    render();
  }
}

/* =========================
   EVENTS + BOOT
========================= */
$("#scope").addEventListener("change", () => { FEED_STATE.key = ""; render(); });
$("#q").addEventListener("input", render);

$("#spicy").addEventListener("change", () => {
  FEED_STATE.key = "";
  render();
  showToast(spicyOn() ? "Spicy Mode: ON üå∂Ô∏è" : "Spicy Mode: OFF");
});

$("#celebrate").addEventListener("click", () => {
  confettiBurst();
  const {rows} = compute($("#scope").value);
  const topCount = rows.length ? (Number(rows[0].count)||0) : 0;
  const leaders = rows.filter(r => (Number(r.count)||0) === topCount && topCount > 0);

  if(!leaders.length){
    showToast("No dawgs yet ‚Äî be the first üå≠");
    return;
  }

  if(leaders.length === 1){
    showToast(`All hail ${leaders[0].displayName} üèÜ`);
    return;
  }

  const names = leaders.slice(0,3).map(x => x.displayName);
  const extra = leaders.length > 3 ? ` +${leaders.length-3} more` : "";
  showToast(`All hail the tied leaders: ${names.join(", " )}${extra} üèÜ`);
});

$("#refreshNow").addEventListener("click", () => {
  loadLiveData();
});

// keyboard
document.addEventListener("keydown", (e) => {
  if(e.key === "/") {
    e.preventDefault();
    $("#q").focus();
  }
  if(e.key === "Escape") {
    $("#q").value = "";
    $("#q").blur();
    render();
  }
});

// infinite scroll
(function(){
  const sentinel = document.getElementById("feedSentinel");
  if(!sentinel) return;
  const io = new IntersectionObserver((entries) => {
    if(entries.some(e => e.isIntersecting)) appendMoreFeed();
  }, {root: null, rootMargin: "900px 0px"});
  io.observe(sentinel);
})();

// boot
render();
showToast("Spicy Mode: ON üå∂Ô∏è");

// intro animation
(function(){
  const scene = document.getElementById("introScene");
  if(!scene) return;
  setTimeout(() => scene.classList.add("done"), 3900);
  setTimeout(() => scene.remove(), 4400);
})();

loadLiveData();
setInterval(loadLiveData, AUTO_REFRESH_MIN * 60 * 1000);
</script>
</body>
</html>
